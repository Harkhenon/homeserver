#!/bin/bash

# Clean named.conf file 

if [ -e "/etc/bind/named.conf" ]; then
    rm /etc/bind/named.conf;
    touch /etc/bind/named.conf;
    blue_info "File named.conf cleaned";
fi

# Create/Clean log folder

if [ -d "/var/log/homeserver" ]; then
    rm -R $HOMESERVER_LOG_PATH;
    mkdir $HOMESERVER_LOG_PATH;
    blue_info "Folder $HOMESERVER_LOG_PATH cleaned and created";
else
    mkdir $HOMESERVER_LOG_PATH
fi

# We create the main web folder and delete the old /var/www/html

if [ -d /var/www/html ]; then
    rm -R /var/www/html;
fi

cp $PATTERNS_PATH/apachedefault.conf /etc/apache2/sites-available/000-default.conf

# Create log files

touch $HOMESERVER_LOG_PATH/error.log;
touch $HOMESERVER_LOG_PATH/activity.log;

# Bind zone file

touch /etc/bind/$fqdn.zone;

# PHP-FPM pool file

touch /etc/php/$SHORTPHPVERSION/fpm/pool.d/$fqdn.pool.conf;

# Filling zone file and Bind9 named.conf

sed 's/{fqdn}/'$fqdn'/g;s/{ip}/'$(wget -qO- http://ipecho.net/plain | xargs echo)'/g' $PATTERNS_PATH/zonefile.bind > /etc/bind/$fqdn.zone;
sed 's/{fqdn}/'$fqdn'/g;s/{ip}/'$(wget -qO- http://ipecho.net/plain | xargs echo)'/g' $PATTERNS_PATH/sqlSubDomainZone.bind > /etc/bind/sql.$fqdn.sub;
sed 's/{fqdn}/'$fqdn'/g;s/{ip}/'$(wget -qO- http://ipecho.net/plain | xargs echo)'/g' $PATTERNS_PATH/zone.bind > /etc/bind/named.conf;

# Filling virtualhost file for Apache

sed 's/{fqdn}/'$fqdn'/g' $PATTERNS_PATH/virtualhost.apache > /etc/apache2/sites-available/$fqdn.conf;
sed 's/{fqdn}/'$fqdn'/g' $PATTERNS_PATH/virtualhost-sql.apache > /etc/apache2/sites-available/sql.$fqdn.conf;

# Filling PHP-FPM pool file

sed 's/{fqdn}/'$fqdn'/g' $PATTERNS_PATH/pool.php-fpm > /etc/php/$SHORTPHPVERSION/fpm/pool.d/$fqdn.pool.conf;

# Editing the apache default website

cp $PATTERNS_PATH/apachedefault.conf /etc/apache2/sites-available/000-default.conf
