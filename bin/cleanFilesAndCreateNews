#!/bin/bash

# Clean named.conf file 

if [ -e "/etc/bind/named.conf" ]; then
    rm /etc/bind/named.conf;
    touch /etc/bind/named.conf;
    blue_info "File named.conf cleaned";
fi

# Create/Clean log folder

if [ -d "/var/log/homeserver" ]; then
    rm -R /var/log/homeserver;
    mkdir /var/log/homeserver;
    blue_info "Folder /var/log/homeserver cleaned and created";
else
    mkdir /var/log/homeserver
fi

# We create the main web folder and delete the old /var/www/html

if [ -d /var/www/html ]; then
    rm -R /var/www/html;
fi

cp ./pattern/apachedefault.conf /etc/apache2/sites-available/000-default.conf

# Creating/Cleaning the base folder

rm -R /usr/share/homeserver

if [ ! -d $HOMESERVERPATH ]; then
    mkdir /usr/share/homeserver
fi

# Create log files

touch /var/log/homeserver/error.log;
touch /var/log/homeserver/activity.log;

# Bind zone file

touch /etc/bind/$fqdn.zone;

# PHP-FPM pool file

touch /etc/php/$SHORTPHPVERSION/fpm/pool.d/$fqdn.pool.conf;

# Filling zone file and Bind9 named.conf

sed 's/{fqdn}/'$fqdn'/g;s/{ip}/'$(wget -qO- http://ipecho.net/plain | xargs echo)'/g' $SCRIPTPATH/pattern/zonefile.bind > /etc/bind/$fqdn.zone;
sed 's/{fqdn}/'$fqdn'/g;s/{ip}/'$(wget -qO- http://ipecho.net/plain | xargs echo)'/g' $SCRIPTPATH/pattern/zone.bind > /etc/bind/named.conf;

# Filling virtualhost file for Apache

sed 's/{fqdn}/'$fqdn'/g' ./pattern/virtualhost.apache > /etc/apache2/sites-available/$fqdn.conf;

# Filling PHP-FPM pool file

sed 's/{fqdn}/'$fqdn'/g' ./pattern/pool.php-fpm > /etc/php/$SHORTPHPVERSION/fpm/pool.d/$fqdn.pool.conf;

# Editing the apache default website

cp ./pattern/apachedefault.conf /etc/apache2/sites-available/000-default.conf
